<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="view_rubberbydate_form" model="ir.ui.view">
        <field name="name">rubberbydate.form</field>
        <field name="model">rubber.date</field>
        <field name="arch" type="xml">
            <form string="NHAP SAN LUONG" autosave="false">
              <style>
                /* Reset any frozen header styles for editable trees */
                .o_list_view .o_list_table thead th {
                    position: static !important;
                    top: auto !important;
                    z-index: auto !important;
                }
                
                /* Table layout styles */
                .o_list_view .o_list_table {
                  table-layout: auto;
                  width: 100%;
                }
                
                /* Minimize padding and fit content */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table th,
                .o_field_one2many[name="deliver_line_ids"] .o_list_table td {
                    white-space: nowrap;
                    padding: 4px 6px !important;
                    text-align: center;
                    border-right: 1px solid #dee2e6 !important;
                    border-left: 1px solid #dee2e6 !important;
                }
                
                /* Add horizontal borders for complete grid */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table tr {
                    border-bottom: 1px solid #dee2e6 !important;
                }
                
                /* Header styling with borders */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table thead th {
                    background-color: #6c757d !important;
                    border-bottom: 2px solid #dee2e6 !important;
                    font-weight: bold;
                    color: white !important;
                }
                
                /* Ensure header background is applied consistently */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table thead tr th {
                    background-color: #6c757d !important;
                    color: white !important;
                    font-weight: 600 !important;
                }
                
                /* Override any Odoo default header styling */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table thead {
                    background-color: #6c757d !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_list_view .o_list_table thead th {
                    background-color: #6c757d !important;
                    background: #6c757d !important;
                    color: white !important;
                }
                
                /* Remove double borders */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table th:first-child,
                .o_field_one2many[name="deliver_line_ids"] .o_list_table td:first-child {
                    border-left: none !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_list_table th:last-child,
                .o_field_one2many[name="deliver_line_ids"] .o_list_table td:last-child {
                    border-right: none !important;
                }
                
                /* Global column width variables - same across all deliver/sell line fields */
                .o_field_one2many {
                    --col-daily-width: 65px;
                    --col-product-width: 60px;
                    --col-soluong-width: 65px;    /* soluong/soluongtt */
                    --col-do-width: 45px;         /* do/dott */
                    --col-quykho-width: 65px;     /* quykho/quykhott */
                    --col-status-width: 65px;
                    --col-button-width: 50px;
                    --col-to-width: 60px;         /* to_name - specific to xetai */
                    --col-selected-width: 30px;   /* is_selected - specific to order fields */
                    --col-daily-ban-width: 65px;  /* daily_ban - specific to order fields */
                }
                
                /* Apply widths based on field data attributes */
                .o_field_one2many .o_list_table th[data-name="daily_id"],
                .o_field_one2many .o_list_table td[data-name="daily_id"] {
                    min-width: var(--col-daily-width) !important;
                    width: var(--col-daily-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="product_id"],
                .o_field_one2many .o_list_table td[data-name="product_id"],
                .o_field_one2many .o_list_table th[data-name="product_name"],
                .o_field_one2many .o_list_table td[data-name="product_name"] {
                    min-width: var(--col-product-width) !important;
                    width: var(--col-product-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="soluong"],
                .o_field_one2many .o_list_table td[data-name="soluong"],
                .o_field_one2many .o_list_table th[data-name="soluongtt"],
                .o_field_one2many .o_list_table td[data-name="soluongtt"] {
                    min-width: var(--col-soluong-width) !important;
                    width: var(--col-soluong-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="do"],
                .o_field_one2many .o_list_table td[data-name="do"],
                .o_field_one2many .o_list_table th[data-name="dott"],
                .o_field_one2many .o_list_table td[data-name="dott"] {
                    min-width: var(--col-do-width) !important;
                    width: var(--col-do-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="quykho"],
                .o_field_one2many .o_list_table td[data-name="quykho"],
                .o_field_one2many .o_list_table th[data-name="quykhott"],
                .o_field_one2many .o_list_table td[data-name="quykhott"] {
                    min-width: var(--col-quykho-width) !important;
                    width: var(--col-quykho-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="state"],
                .o_field_one2many .o_list_table td[data-name="state"] {
                    min-width: var(--col-status-width) !important;
                    width: var(--col-status-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="to_name"],
                .o_field_one2many .o_list_table td[data-name="to_name"] {
                    min-width: var(--col-to-width) !important;
                    width: var(--col-to-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="is_selected"],
                .o_field_one2many .o_list_table td[data-name="is_selected"] {
                    min-width: var(--col-selected-width) !important;
                    width: var(--col-selected-width) !important;
                }
                
                .o_field_one2many .o_list_table th[data-name="daily_ban"],
                .o_field_one2many .o_list_table td[data-name="daily_ban"] {
                    min-width: var(--col-daily-ban-width) !important;
                    width: var(--col-daily-ban-width) !important;
                }
                
                /* Button column (last column for editable tables) */
                .o_field_one2many .o_list_table th:last-child,
                .o_field_one2many .o_list_table td:last-child {
                    min-width: var(--col-button-width) !important;
                    width: var(--col-button-width) !important;
                }
                
                /* Fallback: nth-child selectors for when data-name attributes aren't available */
                /* This ensures consistency even if field attributes are missing */
                
                /* Standard deliver line structure in nhapsanluong: daily_id, product_id, soluong, do, buttons, state */
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(1),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(1) {
                    min-width: var(--col-daily-width) !important;
                    width: var(--col-daily-width) !important;
                }
                
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(2),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(2) {
                    min-width: var(--col-product-width) !important;
                    width: var(--col-product-width) !important;
                }
                
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(3),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(3) {
                    min-width: var(--col-soluong-width) !important;
                    width: var(--col-soluong-width) !important;
                }
                
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(4),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(4) {
                    min-width: var(--col-do-width) !important;
                    width: var(--col-do-width) !important;
                }
                
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(5),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(5) {
                    min-width: var(--col-button-width) !important;
                    width: var(--col-button-width) !important;
                }
                
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table th:nth-child(6),
                .o_field_one2many[name*="deliver_line_ids"] .o_list_table td:nth-child(6) {
                    min-width: var(--col-status-width) !important;
                    width: var(--col-status-width) !important;
                }
                
                /* Ensure the table header text is always visible */
                .o_field_one2many .o_list_table th {
                    white-space: nowrap !important;
                    overflow: visible !important;
                    text-overflow: clip !important;
                    padding: 8px 12px !important;
                    font-weight: bold !important;
                }
                
                /* Ensure table cells have minimum padding to show content properly */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table td {
                    min-height: 40px !important;
                    padding: 6px 12px !important;
                    white-space: nowrap !important;
                }
                
                /* Keep freeze-table styles only for summary tables */
                .freeze-table th {
                    position: sticky;
                    top: 0;
                    background: #f5f5f5;
                    z-index: 2;
                }
                .freeze-table td:first-child,
                .freeze-table th:first-child {
                    position: sticky;
                    left: 0;
                    background: #f5f5f5;
                    z-index: 3;
                }
                .freeze-table th:first-child {
                    z-index: 4;
                }
                
                /* Enable numeric input behavior for number fields */
                .o_field_one2many[name="deliver_line_ids"] input[data-field="soluong"],
                .o_field_one2many[name="deliver_line_ids"] input[data-field="do"],
                .o_field_one2many[name="deliver_line_ids"] input[data-field="quykho"] {
                    text-align: right;
                    font-family: monospace;
                }
                 /* Style for number inputs */
                .o_field_one2many[name="deliver_line_ids"] .o_field_float input,
                .o_field_one2many[name="deliver_line_ids"] .o_field_integer input {
                    text-align: right;
                    font-family: monospace;
                }
                
                /* Done button styling */
                .done-button {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #007cba;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 9999;
                    display: none;
                    transition: all 0.3s ease;
                }
                
                .done-button:hover {
                    background: #005f8a;
                    transform: translateY(-2px);
                }
                
                .done-button:active {
                    transform: translateY(0);
                }
                
                /* CSS for product_id removed - now handled by JavaScript */
                
                /* Style the "Add a line" link as a prominent button */
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a {
                    display: inline-block !important;
                    background: #28a745 !important;
                    color: white !important;
                    padding: 10px 20px !important;
                    border-radius: 6px !important;
                    text-decoration: none !important;
                    font-weight: bold !important;
                    font-size: 14px !important;
                    margin: 10px 0 !important;
                    border: none !important;
                    cursor: pointer !important;
                    transition: all 0.3s ease !important;
                    min-height: 44px !important; /* Touch-friendly size */
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    width: auto !important;
                    min-width: 150px !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a:hover {
                    background: #218838 !important;
                    transform: translateY(-1px) !important;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a:active {
                    transform: translateY(0) !important;
                    background: #1e7e34 !important;
                }
                
                /* Make the container more prominent */
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add {
                    text-align: center !important;
                    padding: 10px !important;
                    border-top: 1px solid #dee2e6 !important;
                    background: #f8f9fa !important;
                }
                
                /* Add plus icon before text and change text */
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a::before {
                    content: "+ ";
                    font-weight: bold;
                    font-size: 16px;
                }
                
                /* Change "Add a line" text to "Thêm dòng" and align left */
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a {
                    text-indent: -9999px;
                    position: relative;
                    text-align: left !important;
                    justify-content: flex-start !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_x2many_list_row_add a::after {
                    content: "Thêm dòng";
                    position: absolute;
                    left: 20px;
                    right: 0;
                    top: 0;
                    bottom: 0;
                    display: flex;
                    align-items: center;
                    text-indent: 0;
                    text-align: left;
                }
                
                /* Table layout improvements for deliver_line_ids */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table {
                    table-layout: auto !important;
                    width: 100% !important;
                }
                
                /* Prevent table container from shrinking */
                .o_field_one2many[name="deliver_line_ids"] .o_list_view {
                    overflow-x: auto !important;
                    min-width: 100% !important;
                }
                
                /* Force table to maintain structure even with empty content */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table td:empty::before {
                    content: "\00a0"; /* Non-breaking space to maintain cell height */
                    visibility: hidden;
                }
                
                /* Ensure empty many2one fields show placeholder */
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one input:placeholder-shown {
                    min-width: 60px !important; /* Reduced for mobile */
                }
                
                /* Force column headers to always be visible */
                .o_field_one2many[name="deliver_line_ids"] .o_list_table thead {
                    position: relative;
                    z-index: 1;
                }
                
                /* Force consistent column widths - override any Odoo defaults */
                /* Hide the edit/open record icons for many2one fields in deliver_line_ids */
                .o_field_one2many[name="deliver_line_ids"] .o_external_button {
                    display: none !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one .o_external_button {
                    display: none !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one .fa-external-link {
                    display: none !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one .fa-pencil {
                    display: none !important;
                }
                
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one .fa-edit {
                    display: none !important;
                }
                
                /* Keep only the dropdown arrow visible */
                .o_field_one2many[name="deliver_line_ids"] .o_field_many2one .o_input_dropdown {
                    display: block !important;
                }
                
                /* Visual feedback for unsaved changes */
                .o_field_one2many[name="deliver_line_ids"] input[data-dirty="true"] {
                    border-left: 3px solid #ffc107 !important; /* Yellow border for unsaved data */
                    background-color: #fff9e6 !important; /* Light yellow background */
                }
                
                /* Tooltip for unsaved changes */
                .o_field_one2many[name="deliver_line_ids"] input[data-dirty="true"]::before {
                    content: "Chưa lưu - Sẽ lưu khi nhấn Save";
                    position: absolute;
                    top: -25px;
                    left: 0;
                    background: #ffc107;
                    color: #000;
                    padding: 2px 6px;
                    border-radius: 3px;
                    font-size: 11px;
                    white-space: nowrap;
                    z-index: 1000;
                    pointer-events: none;
                    opacity: 0;
                    transition: opacity 0.3s;
                }
                
                .o_field_one2many[name="deliver_line_ids"] input[data-dirty="true"]:hover::before {
                    opacity: 1;
                }
              </style>
            
            <script type="text/javascript">
            //<![CDATA[
                (function() {
                    'use strict';
                    
                    // Prevent multiple script executions
                    if (window.deliverLineSetupDone) {
                        return;
                    }
                    window.deliverLineSetupDone = true;
                    
                    // Cleanup function to prevent memory leaks
                    function cleanup() {
                        // Remove any event listeners we added
                        if (window.deliverLineObserver) {
                            window.deliverLineObserver.disconnect();
                            window.deliverLineObserver = null;
                        }
                        window.deliverLineSetupDone = false;
                    }
                    
                    // Add cleanup on page unload to prevent crashes
                    window.addEventListener('beforeunload', cleanup);
                    window.addEventListener('pagehide', cleanup);
                
                document.addEventListener('DOMContentLoaded', function() {
                    // Simple function to ensure column widths (using CSS variables)
                    function maintainTableStructure() {
                        const tableContainer = document.querySelector('.o_field_one2many[name="deliver_line_ids"]');
                        if (tableContainer) {
                            const table = tableContainer.querySelector('.o_list_table');
                            if (table) {
                                // Get CSS variable values
                                const computedStyle = getComputedStyle(tableContainer);
                                const dailyWidth = computedStyle.getPropertyValue('--col-daily-width').trim();
                                const productWidth = computedStyle.getPropertyValue('--col-product-width').trim();
                                const soluongWidth = computedStyle.getPropertyValue('--col-soluong-width').trim();
                                const doWidth = computedStyle.getPropertyValue('--col-do-width').trim();
                                const statusWidth = computedStyle.getPropertyValue('--col-status-width').trim();
                                const buttonWidth = computedStyle.getPropertyValue('--col-button-width').trim();
                                
                                // Apply to headers
                                const headers = table.querySelectorAll('thead th');
                                if (headers[0]) { headers[0].style.minWidth = dailyWidth; headers[0].style.width = dailyWidth; }
                                if (headers[1]) { headers[1].style.minWidth = productWidth; headers[1].style.width = productWidth; }
                                if (headers[2]) { headers[2].style.minWidth = soluongWidth; headers[2].style.width = soluongWidth; }
                                if (headers[3]) { headers[3].style.minWidth = doWidth; headers[3].style.width = doWidth; }
                                if (headers[4]) { headers[4].style.minWidth = statusWidth; headers[4].style.width = statusWidth; }
                                if (headers[5]) { headers[5].style.minWidth = buttonWidth; headers[5].style.width = buttonWidth; }
                                
                                // Apply to cells
                                table.querySelectorAll('td:nth-child(1)').forEach(cell => { cell.style.minWidth = dailyWidth; cell.style.width = dailyWidth; });
                                table.querySelectorAll('td:nth-child(2)').forEach(cell => { cell.style.minWidth = productWidth; cell.style.width = productWidth; });
                                table.querySelectorAll('td:nth-child(3)').forEach(cell => { cell.style.minWidth = soluongWidth; cell.style.width = soluongWidth; });
                                table.querySelectorAll('td:nth-child(4)').forEach(cell => { cell.style.minWidth = doWidth; cell.style.width = doWidth; });
                                table.querySelectorAll('td:nth-child(5)').forEach(cell => { cell.style.minWidth = statusWidth; cell.style.width = statusWidth; });
                                table.querySelectorAll('td:nth-child(6)').forEach(cell => { cell.style.minWidth = buttonWidth; cell.style.width = buttonWidth; });
                            }
                        }
                    }
                    
                    // Simplified setup function
                    function setupFields() {
                        try {
                            console.log('Setting up deliver_line_ids fields...');
                            
                            // Maintain table structure
                            maintainTableStructure();
                            
                            // Prevent auto-save on line changes
                            preventAutoSave();
                            
                            // Setup manual save when form is saved
                            setupManualSave();
                            
                        } catch (error) {
                            console.error('Error in setupFields:', error);
                        }
                    }
                    
                    // Prevent auto-save on deliver_line_ids changes
                    function preventAutoSave() {
                        try {
                            const container = document.querySelector('.o_field_one2many[name="deliver_line_ids"]');
                            if (!container || container.hasAttribute('data-autosave-disabled')) {
                                return;
                            }
                            container.setAttribute('data-autosave-disabled', 'true');
                            
                            console.log('Setting up auto-save prevention for deliver_line_ids...');
                            
                            // Intercept and prevent auto-save events
                            container.addEventListener('change', function(e) {
                                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                                    console.log('Input changed, preventing auto-save:', e.target);
                                    
                                    // Stop the event from bubbling up to trigger auto-save
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    
                                    // Mark the field as dirty for manual save later
                                    e.target.setAttribute('data-dirty', 'true');
                                    
                                    // Store the changed value
                                    const fieldName = e.target.getAttribute('name') || e.target.getAttribute('data-field') || '';
                                    const value = e.target.value;
                                    
                                    console.log('Cached change:', fieldName, '=', value);
                                    
                                    // Visual feedback that data is unsaved
                                    e.target.style.borderLeft = '3px solid #ffc107'; // Yellow border for unsaved
                                    
                                    return false;
                                }
                            }, true); // Use capture phase to catch early
                            
                            // Also prevent blur events that might trigger save
                            container.addEventListener('blur', function(e) {
                                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                                    console.log('Input blur, preventing auto-save:', e.target);
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }
                            }, true);
                            
                            // Prevent focusout events that might trigger save
                            container.addEventListener('focusout', function(e) {
                                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                                    console.log('Input focusout, preventing auto-save');
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    return false;
                                }
                            }, true);
                            
                            // Override any Odoo auto-save mechanisms
                            const inputs = container.querySelectorAll('input, select');
                            inputs.forEach(function(input) {
                                // Remove any existing change handlers that might trigger save
                                const newInput = input.cloneNode(true);
                                input.parentNode.replaceChild(newInput, input);
                                
                                // Add our own change handler
                                newInput.addEventListener('input', function(e) {
                                    console.log('Input event (no auto-save):', e.target.value);
                                    e.target.setAttribute('data-dirty', 'true');
                                    e.target.style.borderLeft = '3px solid #ffc107';
                                });
                                
                                newInput.addEventListener('change', function(e) {
                                    console.log('Change event (no auto-save):', e.target.value);
                                    e.target.setAttribute('data-dirty', 'true');
                                    e.target.style.borderLeft = '3px solid #ffc107';
                                    e.stopPropagation();
                                    return false;
                                });
                            });
                            
                            console.log('Auto-save prevention setup complete');
                            
                        } catch (error) {
                            console.error('Error in preventAutoSave:', error);
                        }
                    }
                    
                    // Setup manual save when main form is saved
                    function setupManualSave() {
                        try {
                            // Find the main form save button
                            const saveButtons = document.querySelectorAll('button[data-hotkey="s"], .o_form_button_save, button[name="action_save"]');
                            
                            saveButtons.forEach(function(button) {
                                if (!button.hasAttribute('data-manual-save-handler')) {
                                    button.setAttribute('data-manual-save-handler', 'true');
                                    
                                    button.addEventListener('click', function(e) {
                                        console.log('Save button clicked, processing cached deliver_line_ids changes...');
                                        
                                        // Find all dirty fields and clear their visual indicators
                                        const dirtyFields = document.querySelectorAll('.o_field_one2many[name="deliver_line_ids"] [data-dirty="true"]');
                                        console.log('Found', dirtyFields.length, 'unsaved changes');
                                        
                                        dirtyFields.forEach(function(field) {
                                            field.removeAttribute('data-dirty');
                                            field.style.borderLeft = ''; // Remove yellow border
                                            console.log('Cleared dirty flag for:', field);
                                        });
                                        
                                        // Let the normal save process continue
                                        console.log('Allowing normal form save to proceed...');
                                        
                                    }, true); // Use capture to run before default handlers
                                }
                            });
                            
                            console.log('Manual save setup complete for', saveButtons.length, 'save buttons');
                            
                        } catch (error) {
                            console.error('Error in setupManualSave:', error);
                        }
                    }
                    
                    // Initial setup with proper timing and error handling
                    function initialize() {
                        try {
                            console.log('Initializing deliver_line_ids enhancements...');
                            setupFields();
                        } catch (error) {
                            console.error('Error in initialize:', error);
                        }
                    }
                    
                    // Run setup multiple times to catch dynamic content
                    setTimeout(initialize, 100);
                    setTimeout(initialize, 500);
                    setTimeout(initialize, 1000);
                    
                    // Setup observer for dynamic content with error handling
                    try {
                        const observer = new MutationObserver(function(mutations) {
                            let needsSetup = false;
                            
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                    for (let node of mutation.addedNodes) {
                                        if (node.nodeType === 1) { // Element node
                                            if (node.matches && (
                                                node.matches('tr') || 
                                                node.matches('input') || 
                                                node.querySelector && (
                                                    node.querySelector('input') ||
                                                    node.querySelector('.o_field_widget')
                                                )
                                            )) {
                                                needsSetup = true;
                                                break;
                                            }
                                        }
                                    }
                                }
                            });
                            
                            if (needsSetup) {
                                console.log('DOM change detected, re-running setup...');
                                setTimeout(initialize, 100);
                            }
                        });
                        
                        // Store observer globally for cleanup
                        window.deliverLineObserver = observer;
                        
                        // Observe the document body for changes
                        observer.observe(document.body, {
                            childList: true,
                            subtree: true
                        });
                        
                        console.log('MutationObserver setup complete');
                    } catch (error) {
                        console.error('Error setting up MutationObserver:', error);
                    }
                    
                }); // End DOMContentLoaded
                
                })(); // End IIFE
            //]]>
            </script>
            
            <sheet>
                <header>
                    <field name="thongbao" decoration-danger="1" nolabel="1" decoration-bf="1"/>
                    <button name="recompute_calculated_fields" 
                            string="Recompute Fields" 
                            type="object"
                            class="oe_highlight"/>                    
                </header>
                  <field name="ngaygiao" invisible="1"/>
                    <notebook>
                        <page string="Giao mũ" name="giaomu" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}">
                          <sheet>
                            <group>
                              <group string = "TỔ TRƯỞNG NHẬP">
                                <field name="do_giao"/>
                                <field name="ke"/>
                                <field name="mutrangthung"/>
                                <field name="xe"/>
                              </group>
                              <field name="deliver_line_ids" nolabel="1">                                
                                <tree default_order='product_id asc' create="1" delete="1" editable="bottom">
                                  <field name="ngay" optional ="hide"/>
                                  <field name="to_id" optional ="hide"/>
                                  <field name="daily_id"/>                                  
                                  <field name="product_id" domain="[('categ_id.name', '=', 'Mũ')]"/>
                                  <field name="soluong" string ="SL"/>
                                  <field name="do"/>
                                  <field name="quykho" optional ="hide"/>
                                  <button name="giaomu" string="GIAO" type="object" class="btn-success"  attrs="{'invisible': [('state','in',['giao','nhan','mua','order'])]}"/>
                                  <button name="sualai" string="SỬA LẠI" type="object" class="btn-success" attrs="{'invisible': [('state','!=','giao')]}"/>
                                  <field name="state"/>                                  
                                  
                                </tree>
                              </field>
                              
                              
                            </group>
                            
                            <div class="container" style="margin-top: 16px;">
                                <h4 style="text-align:center;">TỔNG HỢP MŨ</h4>
                                <table class="table table-bordered freeze-table" style="text-align: center; min-width: 1100px;">
                                    <thead>
                                        <tr style="background-color: gainsboro;">
                                            <th></th>
                                            <th>THU</th>
                                            <th>THỰC TẾ</th>
                                            <th>BÁN</th>
                                            <th>HAO HỤT</th>
                                            <th>KK</th>
                                            <th>Ngày kk</th>
                                            <th>KIỂM KÊ</th>
                                            <th>TỒN</th>
                                            <th>HAO HỤT KK</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>MŨ NƯỚC</strong></td>
                                            <td><field name="nuoc_thu" nolabel="1"/></td>
                                            <td><field name="nuoc_giao" nolabel="1"/></td>
                                            <td><field name="nuoc_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="nuoc_haohut" nolabel="1"/>
                                              <field name="tyle_nuoc_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td><field name="nuockk" nolabel="1"/></td>
                                            <td><field name="nuocnkk" nolabel="1"/></td>
                                            <td><field name="nuoc_tonkk" nolabel="1"/></td>
                                            <td><field name="nuoc_ton" nolabel="1"/></td>
                                            <td><field name="nuoc_hhkk" nolabel="1"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>ĐỘ</strong></td>
                                            <td><field name="do_tb" nolabel="1"/></td>
                                            <td><field name="do_giao" nolabel="1"/></td>
                                            <td><field name="do_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="dolech" nolabel="1"/>
                                              <field name="tyle_do_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                            <td></td>
                                        </tr>
                                        <tr>
                                            <td><strong>MŨ TẠP</strong></td>
                                            <td><field name="tap_thu" nolabel="1"/></td>
                                            <td><field name="tap_giao" nolabel="1"/></td>
                                            <td><field name="tap_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="tap_haohut" nolabel="1"/>
                                              <field name="tyle_tap_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td><field name="tapkk" nolabel="1"/></td>
                                            <td><field name="tapnkk" nolabel="1"/></td>
                                            <td><field name="tap_tonkk" nolabel="1"/></td>
                                            <td><field name="tap_ton" nolabel="1"/></td>
                                            <td><field name="tap_hhkk" nolabel="1"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>MŨ DÂY</strong></td>
                                            <td><field name="day_thu" nolabel="1"/></td>
                                            <td><field name="day_giao" nolabel="1"/></td>
                                            <td><field name="day_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="day_haohut" nolabel="1"/>
                                              <field name="tyle_day_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td><field name="daykk" nolabel="1"/></td>
                                            <td><field name="daynkk" nolabel="1"/></td>
                                            <td><field name="day_tonkk" nolabel="1"/></td>
                                            <td><field name="day_ton" nolabel="1"/></td>
                                            <td><field name="day_hhkk" nolabel="1"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>MŨ ĐÔNG</strong></td>
                                            <td><field name="dong_thu" nolabel="1"/></td>
                                            <td><field name="dong_giao" nolabel="1"/></td>
                                            <td><field name="dong_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="dong_haohut" nolabel="1"/>
                                              <field name="tyle_dong_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td><field name="dongkk" nolabel="1"/></td>
                                            <td><field name="dongnkk" nolabel="1"/></td>
                                            <td><field name="dong_tonkk" nolabel="1"/></td>
                                            <td><field name="dong_ton" nolabel="1"/></td>
                                            <td><field name="dong_hhkk" nolabel="1"/></td>
                                        </tr>
                                        <tr>
                                            <td><strong>MŨ CHÉN</strong></td>
                                            <td><field name="chen_thu" nolabel="1"/></td>
                                            <td><field name="chen_giao" nolabel="1"/></td>
                                            <td><field name="chen_ban" nolabel="1"/></td>
                                            <td>
                                              <field name="chen_haohut" nolabel="1"/>
                                              <field name="tyle_chen_haohut" nolabel="1" widget="html"/>
                                            </td>
                                            <td><field name="chenkk" nolabel="1"/></td>
                                            <td><field name="chennkk" nolabel="1"/></td>
                                            <td><field name="chen_tonkk" nolabel="1"/></td>
                                            <td><field name="chen_ton" nolabel="1"/></td>
                                            <td><field name="chen_hhkk" nolabel="1"/></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                          </sheet>
                        </page>
                        <page string="Thông tin chung">
                          <sheet>
                            <group>
                              <group>
                                <field name="recorded" invisible="1"/>
                                <field name="lo" attrs="{'readonly': [('recorded','=',True)]}"/>
                                <field name="ngay" attrs="{'readonly': [('recorded','=',True)]}"/>                                
                                <field name="to" attrs="{'readonly': [('recorded','=',True)]}" widget="selection"/>
                                <field name="to_name" invisible="1"/>
                                <field name="ctktup"/>
                                <!--<field name="congthuc_kt" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>-->
                                <field name="caoxa" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                              </group>
                              <group>
                                <field name="nam_kt" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                                <field name="thoitiet" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                                <field name="thoigian_cao" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>                                
                                <field name="miengcao" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                                <field name="kichthich" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                              </group>
                            </group>
                            <group>
                              <field name="ghi_chu" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}"/>
                            </group>
                            <!--<button name="update_rubber_prices" string="Update Prices" type="object" class="oe_highlight"/>-->
                          </sheet>
                        </page>
                        <page string="Sản lượng mũ cạo" attrs="{'invisible': ['|','&amp;',('to_name','=','TỔ Chung'),('to','=',False),('recorded','=',False)]}">
                          <field name="rubber_line_ids" context="{'skip_rubberline_compute': True}">
                            <tree editable="bottom" create="0" delete="0" default_order="planname asc">
                              <field name="plantation_id" optional="hide" style="border-top-style: solid !important;border-width: 1px !important"/>
                              <field name="planname" string="STT"/>
                              <field name="phep" style="border-top-style: solid !important;border-width: 1px !important;"/>
                              <field name="empname" style="border-top-style: solid !important;border-width: 1px !important;"/>
                              <field name="munuoc1" style="border-top-style: solid !important;border-width: 1px !important;" sum="munuoc1" optional="show"/>
                              <field name="munuoc2" style="border-top-style: solid !important;border-width: 1px !important;" optional="hide"/>
                              <field name="munuoc3" style="border-top-style: solid !important;border-width: 1px !important;" optional="hide"/>
                              <field name="mutap1" style="border-top-style: solid !important;border-width: 1px !important;" sum="mutap1" optional="show"/>
                              <field name="mutap2" style="border-top-style: solid !important;border-width: 1px !important;" optional="hide"/>
                              <field name="congnuoc" style="border-top-style: solid !important;border-width: 1px !important;" sum="congnuoc" optional="hide"/>
                              <field name="congtap" style="border-top-style: solid !important;border-width: 1px !important;" sum="congtap" optional="hide"/>
                              <field name="cong" style="border-top-style: solid !important;border-width: 1px !important;" sum="cong" optional="show"/>                              
                              <field name="chenhlechmu" style="border-top-style: solid !important;border-width: 1px !important;" digits = "[42,0]" decoration-success="chenhlechmu >= 0" decoration-danger="chenhlechmu &lt; 0" optional="show"/>
                              <field name="mulantruoc" style="border-top-style: solid !important;border-width: 1px !important;" digits = "[42,0]" optional="show"/>
                              <field name="mudaotruoc" style="border-top-style: solid !important;border-width: 1px !important;" optional="show"/> 
                              <field name="do" style="border-top-style: solid !important;border-width: 1px !important;" optional="show"/>
                              <field name="mudong" string="Đông" style="border-top-style: solid !important;border-width: 1px !important;" sum="mudong" optional="show"/>
                              <field name="muday" string="Dây" style="border-top-style: solid !important;border-width: 1px !important;" sum="muday" optional="show"/>
                              <field name="muchen" string="Chén" style="border-top-style: solid !important;border-width: 1px !important;" sum="muchen" optional="show"/>
                              <field name="ctktup" optional="hide"/>
                              <field name="kichthich" style="border-top-style: solid !important;border-width: 1px !important" optional="hide"/>
                              <field name="caoxa" style="border-top-style: solid !important;border-width: 1px !important" optional="show"/>
                              <field name="ghichu" style="border-top-style: solid !important;border-width: 1px !important" optional="show"/>
                            </tree>
                            <!--<form string="Mu CN">
                              <group>                                
                                <group>
                                  <field name="planname"/>
                                </group>
                                <group>
                                  <field name="empname" string="CN" />
                                </group>
                                <field name="phep" string="Chấm công"/>
                              </group>
                                <group>
                                <div style="overflow-x: auto; width: 100%;">
                                  <table class="table table-bordered" style="min-width: 320px; width: 100%; max-width: 100%; text-align: center; font-size: 14px; table-layout: fixed; word-break: break-word;">
                                  <tbody>
                                    <tr>
                                    <th style="width:33%;">Nước</th>
                                    <th style="width:34%;">Tạp</th>
                                    <th style="width:33%;">Độ</th>
                                    </tr>
                                    <tr>
                                    <td>
                                      <field name="munuoc1" nolabel="1" options="{'on_click_select': true}"/>
                                    </td>
                                    <td>
                                      <field name="mutap1" nolabel="1" options="{'on_click_select': true}"/>
                                    </td>
                                    <td>
                                      <field name="do" nolabel="1" digits="[42,0]" options="{'on_click_select': true}"/>
                                    </td>
                                    </tr>
                                    <tr>
                                    <th>Đông</th>
                                    <th>Dây</th>
                                    <th>Chén</th>
                                    </tr>
                                    <tr>
                                    <td>
                                      <field name="mudong" nolabel="1" options="{'on_click_select': true}"/>
                                    </td>
                                    <td>
                                      <field name="muday" nolabel="1" options="{'on_click_select': true}"/>
                                    </td>
                                    <td>
                                      <field name="muchen" nolabel="1" options="{'on_click_select': true}"/>
                                    </td>
                                    </tr>
                                    <tr>
                                    <th>CỘNG</th>
                                    <th>LẦN TRƯỚC</th>
                                    <th>DAO TRƯỚC</th>
                                    </tr>
                                    <tr>
                                    <td>
                                      <field name="cong" />
                                    </td>
                                    <td>
                                      <field name="mulantruoc" />
                                    </td>
                                    <td>
                                      <field name="mudaotruoc" />
                                    </td>
                                    </tr>
                                  </tbody>
                                  </table>
                                </div>
                                <style>
                                  @media (max-width: 600px) {
                                  .table-bordered th, .table-bordered td {
                                    padding: 4px !important;
                                    font-size: 12px !important;
                                  }
                                  .table-bordered {
                                    min-width: 0 !important;
                                  }
                                  }
                                </style>
                                <script type="text/javascript">
                                  // Select all text when input is focused (works for Odoo web views)
                                  document.addEventListener('focusin', function(e) {
                                    if (e.target.tagName === 'INPUT' &amp;&amp; e.target.type === 'text') {
                                      e.target.select();
                                    }
                                  });
                                </script>
                                </group>
                                <group>
                                  <field name="ghichu" string="Ghi chú" />                                
                                </group>
                            </form>-->
                          </field>
                        </page>
                        <page string="Ghi Chú" attrs="{'invisible': ['&amp;',('to','=',False),('recorded','=',False)]}">
                          <sheet>
                            <group>
                              <field name="note" nolabel="1"/>
                            </group>
                          </sheet>
                        </page>
                      </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids" groups="base.group_user"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <record model="ir.ui.view" id="view_rubberbydate_tree">
        <field name="name">rubberbydate.tree</field>
        <field name="model">rubber.date</field>
        <field name="arch" type="xml">
          <tree string="Rubber By Date Tree View" multi_edit="1" default_order="ngay desc" 
                decoration-bf="kichthich == True" 
                decoration-warning="(miengcao =='2 miệng') or (miengcao =='Miệng ngửa cũ')" 
                decoration-info="miengcao =='Miệng ngửa mới'">
            <field name="ngay_format"/>
            <field name="rubber_line_ids" optional="hide"/>
            <field name="to_name" optional="hide" />
            <field name="id" optional="hide"/>
            <field name="recorded" invisible="1"/>
            <field name="ngay" attrs="{'readonly': [('recorded','=',True)]}" invisible="1"/>
             
            <field name="lo" attrs="{'readonly': [('recorded','=',True)]}"/>
            <field name="tongmu" string="TỔNG" optional="show"/>
            <field name="nam_kt" optional="hide"/>
            <field name="nuoc_thu" optional="hide"/>
            <field name="tap_thu" optional="hide"/>
            <field name="day_thu" optional="hide"/>
            <field name="chen_thu" optional="hide"/>
            <field name="dong_thu" optional="hide"/>
            <field name="day_ban" optional="hide"/>
            
            <field name="mulantruoc" digits = "[42,0]" optional="show"/>            
            <field name="chenhlechmu" digits = "[42,0]" decoration-success="chenhlechmu >= 0" decoration-danger="chenhlechmu &lt; 0" optional="show"/>
            <field name="mudaotruoc" optional="hide"/> 
            <field name="do_tb"/>
            <field name="do_giao"/>
            <field name="dolech" decoration-success="dolech > 0" decoration-danger="dolech &lt; 0"/>
            <field name="quykho" digits = "[42,0]" optional="show"/>
            <field name="kholantruoc" digits = "[42,0]" optional="show"/>
            <field name="chenhlechkho" digits = "[42,0]" decoration-success="chenhlechkho >= 0" decoration-danger="chenhlechkho &lt; 0" optional="show" widget="percentage"/>
            <field name="daoup" optional="hide"/>
            <field name="miengcao" optional="hide"/> 
            <field name="dao_kt"/> 
            <field name="lan_kt"/>
            <field name="nuoc_ban" digits="[42, 0]" string="Nước bán" optional="hide"/>
            <field name="tap_ban" digits="[42, 0]" string="Tạp bán" optional="hide"/>
            <field name="day_ban" digits="[42, 1]" string="Dây bán" optional="hide"/> 
            <field name="kichthich"/>
            <field name="ctktup" optional="show"/>            
            <field name="gianuoc" digits="[42,0]" groups="base.group_erp_manager" optional="hide"/>
            <field name="giatap" digits="[42,0]" groups="base.group_erp_manager" optional="hide"/>
            <field name="giaday" digits="[42,0]" groups="base.group_erp_manager" optional="hide"/>
            <field name="giachen" digits="[42,0]" groups="base.group_erp_manager" optional="hide"/>
            <field name="tien" digits="[42,0]" groups="base.group_erp_manager"/>
            
            <field name="thoitiet" optional="show"/>                                  
            <field name="ghi_chu" optional="hide"/>
          </tree>
        </field>
    </record>   

    <record id="view_rubberbydate_search" model="ir.ui.view">
        <field name="name">rubberbydate.search</field>
        <field name="model">rubber.date</field>
        <field name="arch" type="xml">
            <search>
                <field name="daoup" />
                <field name="daongua" />
                <field name="kt_daoup" />
                <filter name="2024" string="2024" domain="[('ngay','&lt;=',time.strftime('2025-01-31')),('ngay','&gt;=',time.strftime('2024-02-01'))]"/>
                <filter name="2023" string="2023" domain="[('nam_kt','=','2023')]"/>
                <filter name="2025" string="2025" domain="[('nam_kt','=','2025')]"/>
                <group expand="0" string="Group By">
                    <filter name="to_name" string="Tổ" context="{'group_by': 'to_name'}" />
                    <filter name="namkt" string="NămKT" context="{'group_by': 'nam_kt'}" />
                    <filter name="thang" string="Tháng" context="{'group_by': 'ngay'}" />
                </group>
            </search>
        </field>
    </record>

    <record id="action_nhapsanluong" model="ir.actions.act_window">
        <field name="name">Nhập Sản Lượng</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">rubber.date</field>
        <field name="view_mode">tree,form</field>
        <field name="context">{"search_default_to_name":1,"search_default_namkt":1,}</field>
        <field name="help" type="html">
            <p>
                Nhập sản lượng công nhân cạo hằng ngày.
            </p>
        </field>
    </record>

    <!--<record id="view_sanpham_tree" model="ir.ui.view">
        <field name="name">sanpham.tree</field>
        <field name="model">sanpham</field>
        <field name="arch" type="xml">
            <tree>
                <field name="code"/>
                <field name="name"/>
            </tree>
        </field>
    </record>
    <record id="view_sanpham_form" model="ir.ui.view">
        <field name="name">sanpham.form</field>
        <field name="model">sanpham</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    <group>
                        <field name="code"/>
                        <field name="name"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>
    <record id="action_sanpham" model="ir.actions.act_window">
        <field name="name">Sản phẩm</field>
        <field name="res_model">sanpham</field>
        <field name="view_mode">tree,form</field>
    </record>-->

</odoo>